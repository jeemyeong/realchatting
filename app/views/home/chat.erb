<style type="text/css">
@media (min-width: 768px) {
body {
 overflow: hidden; 
}
#chatlogs { position:relative; margin:1px auto; padding:20px; height: 800px; overflow: hidden; border-width: 5px;}
#timeline { position:relative; margin:1px auto; padding:10px; height: 800px; overflow: hidden; border-width: 5px;}
}  

</style>

<div class="container-fluid">
  <div class="row mbody" style="background-color: #e9f0f5;">
    <div class="col-xs-12 col-lg-6 col-md-6 col-sm-6" style="background-color: white;" id="chatlogs">
      <div class="modal-header">
        <a href="/" class="btn btn-md btn-primary ui-btn ui-shadow ui-corner-all" style="float:right; padding: 5px 15px 5px;" target="_blank"><b>실챗</b></a>
        <span class="modal-title form-signin-heading" style="font-size:25px;"><b><%=@channel.title%></b></span>
          <!--챗 수정-->
          <% unless current_user.nil? %>
            <% if current_user.id == @channel.user_id %>
              <a class="badge" id="chat_edit" style="font-size:16px; color:white;"><b>챗방 수정</b></a>
            <% end %>  
          <% end %>
          <!--챗 수정 끝-->
      </div>
      <div class="modal-header form-signin-heading">
        <ul id="users" style="padding-left: 0px;">
            <h4>현재 접속자<span class="badge" style="font-size:20px"><div id="count"><div class="detach_count"><%=@channel.channel_joiners.all.count%></div></div></span></h4>
            <div class="detach_user">
              <% @channel_user_joiner.each do |u|%>
                <img src="<%=u.user.image.thumb.url ? u.user.image.thumb : "/assets/user_image.jpg"%>" class="img-circle" style="height:30px; width:30px;"><b><%=u.user.nickname %></b><span style="font-size:10px;">(<abbr class="timeago" title="<%=u.created_at.in_time_zone("Seoul").iso8601%>"><%=u.created_at.in_time_zone("Seoul").iso8601%></abbr>)</span>
              <% end %>
              <% @channel_guest_joiner.each do |u|%>
                <img src='/assets/hand.jpg' class='img-circle' style='height:30px; width:30px;'>손님(<%=u.guest.ip_address.reverse[0..2] %>)<span style="font-size:10px;">(<abbr class="timeago" title="<%=u.created_at.in_time_zone("Seoul").iso8601%>"><%=u.created_at.in_time_zone("Seoul").iso8601%></abbr>)</span>
              <% end %>
            </div id="detach_user">
        </ul>
      </div>
      
      <div class="modal-header form-signin-heading" id="allchat_content"><!--chat content-->
        <ul id="logs" style="padding-left: 0px;">
          <% @channel.chat_logs.last(15).each do |c| %> <!--일단 15개만 보여주는걸로 하자-->
        		
              <% if c.user_id == nil %>
                <div class="detach_chat row" style="padding-bottom:10px;"><img src='/assets/hand.jpg' class='img-circle' style='height:30px; width:30px;'>(<%=c.guest.ip_address.reverse[0..2]%>)<span class="shuffle msg"><%=c.msg %></span><abbr class="timeago" style="font-size:12px; float:right;" title="<%=c.created_at.in_time_zone("Seoul").iso8601 %>"><%=c.created_at.in_time_zone("Seoul").iso8601%></abbr><br></div>
              <% else %>
                <div class="detach_chat row" style="padding-bottom:10px;"><img src="<%=c.user.image.thumb.url ? c.user.image.thumb : "/assets/user_image.jpg"%>" class="img-circle" style="height:30px; width:30px;"><b><%=c.user.nickname %></b><span class="shuffle msg"><%=c.msg %></span><abbr class="timeago" style="font-size:12px; float:right;" title="<%=c.created_at.in_time_zone("Seoul").iso8601 %>"><%=c.created_at.in_time_zone("Seoul").iso8601%></abbr><br></div>
              <% end %>
            
          <% end %>
        </ul>
      </div>

      <div class="panel-footer" style="height:100px;">
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-xs-8">
            <textarea class="form-control" style="margin-left: 20px; width:100%; resize: none; float:left;padding-bottom: 15px;" id="btn-input"></textarea>
          </div>
          <div class="col-lg-1 col-md-1 col-sm-2 col-xs-4" style="padding-left:0px;">
            <input type="submit" class="btn btn-primary btn-md" id="btn-chat" style="margin:0px 0px 15px 0px; height:72px; overflow:hidden; border-top-right-radius:10px; border-bottom-right-radius:10px;" value="입력">
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6" id="timeline">
    	<div style="height:50px; background-color:#303e49; font-size:30px; font-weight: bold; color:white; text-align:center; margin:10px 0px 10px 0px; padding-top:10px; border-radius: 25px;">
    		<%=@channel.title%>의 타임라인
    	</div>
    		
      <section id="cd-timeline" style="margin:0px;">
      	<div class="cd-timeline-block" style="width:30%; margin:auto;">
      		<button id="timeline_write" class="btn btn-lg btn-primary ui-btn ui-shadow ui-corner-all">타임라인에 글 남기기  <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>
      	</div>
      	
      	<% @channel.timelines.reverse.each do |t| %>
      	<div class="cd-timeline-block">
          <a href="#<%=t.id%>_timeline" data-toggle="collapse">
      		<div class="cd-timeline-img" style="background:#<%=["75ce66","c03b44","f0ca45"].sample(1).join('')%>">
      			<span class="glyphicon glyphicon-<%=t.button%> glyphicon-center" aria-hidden="true"></span>
      		</div> <!-- cd-timeline-img -->
      		</a>
      		<div class="cd-timeline-content">
      			<h2><img src="<%=t.user.image.thumb.url ? t.user.image.thumb : "/assets/user_image.jpg"%>" class="img-circle" style="height:25px; width:25px;"><%=t.user.nickname%> : <%=t.title%>
              <% unless current_user.nil? %>
                <% if current_user.id == t.user_id %>
                  <a href=# id="timeline_editor_<%=t.id%>" style="float:right;" data-toggle="collapse"><span class="glyphicon glyphicon-scissors" aria-hidden="true"></span></a>
                <% end %>
              <% end %>
            </h2>
            
            <div class="collapse" style="border-top: 1px solid #e5e5e5; margin-top:50px;" id="<%=t.id%>_timeline">
        			<% unless t.image.url.nil? %>
          			<img src="<%=t.image.url%>" style="width:100%; margin-top:20px;" class="img-rounded">
        			<% end %>
        			<p><%=t.text%></p>
              <a href="#<%=t.id%>_repl" style="float:right;" data-toggle="collapse"><span class="glyphicon glyphicon-collapse-down" aria-hidden="true"></span></a>
        			<span class="cd-date"><abbr class="timeago" style="font-size:12px;" title="<%=t.created_at.in_time_zone("Seoul").iso8601 %>"><%=t.created_at.in_time_zone("Seoul").iso8601%></abbr></span>
              <div class="collapse" style="border-top: 1px solid #e5e5e5; margin-top:50px;" id="<%=t.id%>_repl">
                <ul id="<%=t.id%>_replies" style="padding-left: 0px;">
                <% t.timeline_replies.each do |r| %>
                  <p style="font-size:15px;">
                    <img src="<%=r.user.image.thumb.url ? r.user.image.thumb : "/assets/user_image.jpg"%>" class="img-circle" style="height:18px; width:18px;">
                    <%=r.user.nickname%> : <span class="<%=t.id%>_reply"><%=r.reply%></span>
                    <a href="/home/timeline_reply_destroying/<%=t.id%>" style="float:right;margin-left:10px;"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
                    <abbr class="timeago" style="font-size:12px; float:right;" title="<%=r.created_at.in_time_zone("Seoul").iso8601 %>"><%=r.created_at.in_time_zone("Seoul").iso8601%></abbr>
                  </p>
                <% end %>
                </ul>
                
                <div class="row">
                  <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                  <input type="text" id="<%=t.id%>_reply_input" class="form-control" name="reply" placeholder="댓글" style="width:100%" required autofocus>
                  </div>
                  <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                  <input type="submit" class="btn btn-primary" id="<%=t.id%>_reply_submit" style="width:100%" value="입력">
                  </div>
                </div>
              </div>
            </div>
      		</div> <!-- cd-timeline-content -->
      	</div> <!-- cd-timeline-block -->
      	<% end %>
      	
      	<div class="cd-timeline-block">
      		<!-- ... -->
      	</div>
      </section>
    </div>
  </div>
</div>

<div class="modal fade" id="chat_editor" >
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_tag "/home/chat_editing/"+ @channel.id.to_s, method: "post", enctype: "multipart/form-data", class: "form-signin" do %>
        <div class="modal-header">
          <h2 class="modal-title form-signin-heading"><b>챗방 수정</b></h2>
        </div>
        <div class="modal-body">
          <label for="inputTitle">챗 이름</label>
          <input type="text" id="inputTitle" class="form-control" name="title" placeholder="챗 이름" required autofocus>
          <br>
          <label for="inputImage">이미지(선택사항)</label>
          <input type="file" id="inputImage" class="form-control" placeholder="챗 이미지" name="image">
          <br>
        </div>
        <div class="modal-footer">
          <a href="/home/chat_destroying/<%=@channel.id%>" class="btn btn-sm btn-default">챗방 폭파</a>
          <button class="btn btn-sm btn-default" style="margin-left:0px;" data-dismiss="modal">취소</button>
          <button class="btn btn-sm btn-primary" style="margin-left:0px;">챗 수정하기</button>
        </div>
      <% end %>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="timeline_maker">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_tag "/home/timeline_maker/"+ @channel.id.to_s, method: "post", enctype: "multipart/form-data", class: "form-signin", style: "padding: 0px 0px 0px 0px;" do %>
        <div class="modal-header">
          <h2 class="modal-title form-signin-heading"><b>타임라인에 글 남기기</b></h2>
        </div>
        <div class="modal-body">
          <label for="inputTitle">제목</label>
          <input type="text" id="inputTitle" class="form-control" name="title" placeholder="제목" required autofocus>
          <br>
          <label for="inputText">내용</label>
          <textarea id="inputText" class="form-control" name="text" placeholder="내용" rows="4" required autofocus></textarea>
          <br>
          <label for="selectBox">버튼</label>
            <select id="selectBox" name="button">
              <option value="asterisk">asterisk</option>
              <option value="plus">plus</option>
              <option value="euro">euro</option>
              <option value="eur">eur</option>
              <option value="minus">minus</option>
              <option value="cloud">cloud</option>
              <option value="envelope">envelope</option>
              <option value="pencil">pencil</option>
              <option value="glass">glass</option>
              <option value="music">music</option>
              <option value="search">search</option>
              <option value="heart">heart</option>
              <option value="star">star</option>
              <option value="user">user</option>
            </select>
          <br>
          <label for="inputImage">이미지(선택사항)</label>
          <input type="file" id="inputImage" class="form-control" placeholder="챗 이미지" name="image">
          <br>
          
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm btn-default" style="margin-left:0px;" data-dismiss="modal">취소</button>
          <button class="btn btn-sm btn-primary" style="margin-left:0px;">글 남기기</button>
        </div>
      <% end %>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
$(function() {
  var websocket = new WebSocketRails('realchatting-ljm901011.c9.io/websocket');
  var channel = websocket.subscribe("chat_<%=@channel.id%>");  
  var user = websocket.subscribe("user_<%=@channel.id%>");  
  var timeline = websocket.subscribe("timeline_<%=@channel.id%>");  
        $('.shuffle').shuffleLetters(); 
        setInterval(function () {
        $('.shuffle').shuffleLetters(); 
        }, 20000); // 채팅화면이 20초마다 셔플한다.
  	setTimeout(function(){
    $("#btn-input").focus(); // 채팅입력화면으로 가자
	},50);

		
  $("#chat_edit").click(function(){ //챗방 수정
         $('#chat_editor').modal();
  })
  $("#timeline_write").click(function(){ //챗방 수정
         $('#timeline_maker').modal();
  })
    
 
  $("#btn-input").keyup(function(event){ // 엔터 누르면 버튼이 클릭되게 하자
    if(event.keyCode == 13){
        $("#btn-chat").click();
    }
  });

  $("#btn-chat").click(function(){  // ajax로 채팅 데이터를 컨트롤러로 보내버리자
			
			var text = $("#btn-input").val();
			
			if(text.length > 1){
			$.ajax({
         data: {
            <% if user_signed_in? %>
              user_id: "<%= current_user.id %>",
            <% else %>
              guest_id: "<%= @guest.id %>",
            <% end %>
              channel_id: "<%=@channel.id%>",
              msg: $("#btn-input").val()
         },
         url: "/home/send_msg/<%=@channel.id%>",
         success: function(){
          $("#btn-input").val('');
         }
      })};
  });

	<% @channel.timelines.each do |t| %> // 타임라인

  $("#<%=t.id%>_reply_input").keyup(function(event){ // 엔터 누르면 버튼이 클릭되게 하자
    if(event.keyCode == 13){
        $("#<%=t.id%>_reply_submit").click();
    }
  });
  $("#<%=t.id%>_reply_submit").click(function(){  // ajax로 채팅 데이터를 컨트롤러로 보내버리자
  <% if user_signed_in? %>
			
			var reply_<%=t.id%> = $("#<%=t.id%>_reply_input").val();
			
			if(reply_<%=t.id%>.length > 1){
			$.ajax({
         data: {
              user_id: "<%= current_user.id %>",
              channel_id: "<%=@channel.id%>",
              timeline_id: "<%=t.id%>",
              reply: $("#<%=t.id%>_reply_input").val()
         },
         url: "/home/timeline_reply_maker/<%=@channel.id%>",
         success: function(){
          $("#<%=t.id%>_reply_input").val('');
         }
      })};
  <% else %>
  alert("로그인 하셔야 사용가능합니다.")
  <% end %>
  });
  timeline.bind('<%=t.id%>_reply', function(data) {  // 타임라인에서 오는 데이터를 붙이자
    $("#<%=t.id%>_replies").append('<p style="font-size:15px;"><img src="' + data.image + '" class="img-circle" style="height:18px; width:18px;">' + data.nickname + ' : <span class="<%=t.id%>_reply">' + data.reply + '</span><a href="/home/timeline_reply_destroying/' + data.id + '" style="float:right;margin-left:10px;"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a><abbr class="timeago" style="font-size:12px; float:right;" title="' + data.time + '">' + data.time + '</abbr></p>');
    $('.<%=t.id%>_reply').last().shuffleLetters();
    $("abbr.timeago").timeago(); // ago 형태로 바꿔준다.
  }); //데이터 붙이기 끝
  
      $("#timeline_editor_<%=t.id%>").click(function(){ //타임라인 에디터을 눌렀을때 팝업으로 뜨자
      window.open('/home/timeline_editor/<%=t.id%>', '_blank', 'width=800, height=800, toolbar=no, menubar=no, scrollbars=yes, resizable=no, copyhistory=no');
    })
    <% end %> // 타임라인 끝
    
  channel.bind('chat', function(data) {  // 채널에서 오는 데이터를 붙이자
    $("#logs").append('<div class="detach_chat row" style="padding-bottom:10px;">' + data.nickname + 
                      '<span class="shuffle msg">' + data.msg + '</span><abbr class="timeago" style="font-size:5px; float:right;" title="'+data.time+'">'
                      + data.time +  '</abbr><br></div>');
    if(data.count>=50)  // 채팅이 50개 이상이라면
    {$('.detach_chat').first().detach();} // 맨윗채팅을 떼자
    $('.shuffle').last().shuffleLetters();
    $("#btn-input").focus(); // 채팅입력화면으로 가자
    $("abbr.timeago").timeago(); // ago 형태로 바꿔준다.
  }); //데이터 붙이기 끝
  
    $("abbr.timeago").timeago(); //시간을 ago로 보여주자

        setInterval(function () { //접속중이라는 데이터를 10초마다 컨트롤러로 보내자
        $.ajax({data: {<% if user_signed_in? %>
                         user_id: "<%= current_user.id %>",
                       <% else %>
                         guest_id: "<%= @guest.id %>",
                       <% end %>
                         channel_id: "<%=@channel.id%>",
                         signal: true,},
                url: "/home/channel_joiners/<%=@channel.id%>",})
                }, 10000);
  
  user.bind('chat', function(data) {  // 유져에서 오는 접속중 데이터를 붙이자
    $("#users").append('<div class="detach_user">' + data.user_nickname + data.guest_nickname + '<span style="font-size:12px; float:right;"><abbr class="timeago" title="'+data.time+'">'
                      + data.time +  '</abbr> 업데이트됨</span></div>')
    {$('.detach_user').first().detach();} // 기존 유져를 떼자
    $("abbr.timeago").timeago(); // ago 형태로 바꿔준다.
    $("#count").append('<div class="detach_count">' + data.count + '</div>')
    {$('.detach_count').first().detach();} // 기존 유져 카운트를 떼자
  });
  
  $(window).on('scroll', function(){ //타임라인
  	$timeline_block.each(function(){
  		if( $(this).offset().top <= $(window).scrollTop()+$(window).height()*0.75 && $(this).find('.cd-timeline-img').hasClass('is-hidden') ) {
  			$(this).find('.cd-timeline-img, .cd-timeline-content').removeClass('is-hidden').addClass('bounce-in');
  		}
  	});
  });
  
  $("#chatlogs").perfectScrollbar(); //챗로그 스크롤바
  $("#timeline").perfectScrollbar(); //타임라인 스크롤바
  
  // $("#selectBox option:selected").click(function(){
  // })
    
});
</script>
  
  <%= stylesheet_link_tag "reset", "style" %>